<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Spotify Stats (Ultimate Dashboard)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --spotify-green: #1ED760;
            --bg-dark: #0b0b0b;
            --card-bg: #121212;
            --bg-elevated: #181818;
            --text-main: #FFFFFF;
            --text-secondary: #A7A7A7;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --radius-lg: 16px;
            --font-stack: 'Circular', -apple-system, sans-serif;
            --blue-accent: #3b82f6;
            --purple-accent: #8b5cf6;
        }

        body {
            font-family: var(--font-stack); background-color: var(--bg-dark);
            color: var(--text-main); margin: 0; padding: 30px; min-height: 100vh;
        }
        .container { max-width: 1100px; margin: 0 auto; }
        
        h1, h2, h3 { color: var(--text-main); font-weight: 700; margin-top: 0; }
        h1 { color: var(--spotify-green); text-align: center; margin-bottom: 40px; }
        h2 { font-size: 1.5rem; margin-top: 50px; margin-bottom: 20px; }

        /* Stats Cards */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 24px; margin-bottom: 40px;
        }
        .card {
            background: var(--card-bg); padding: 24px; border-radius: var(--radius-lg);
            border: 1px solid var(--border-subtle);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-4px); border-color: rgba(255,255,255,0.1); }
        
        .card.green::before { content:''; position: absolute; top:0; left:0; width:100%; height:4px; background:var(--spotify-green); }
        .card.purple::before { content:''; position: absolute; top:0; left:0; width:100%; height:4px; background:var(--purple-accent); }
        .card.blue::before { content:''; position: absolute; top:0; left:0; width:100%; height:4px; background:var(--blue-accent); }

        .big-stat { font-size: 2.5rem; font-weight: 800; margin: 10px 0 0 0; }
        .stat-label { color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Controls */
        .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn {
            background: var(--bg-elevated); border: 1px solid transparent; color: var(--text-main);
            padding: 8px 24px; border-radius: 99px; cursor: pointer; transition: 0.2s; font-weight: 600;
        }
        .filter-btn:hover, .filter-btn.active {
            background: var(--spotify-green); color: black;
        }

        /* Tables & Lists */
        .track-table { width: 100%; border-collapse: separate; border-spacing: 0 4px; }
        .track-table th { text-align: left; color: var(--text-secondary); padding: 10px; font-size: 0.8rem; text-transform: uppercase; }
        .track-table td { padding: 12px; background: rgba(255,255,255,0.03); }
        .track-table tr:first-child td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        .track-table tr:first-child td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

        /* Login Screen */
        #login-section {
            height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .btn-spotify {
            background: var(--spotify-green); color: black; border: none; padding: 16px 48px;
            border-radius: 99px; font-size: 1.1rem; cursor: pointer; font-weight: 800;
            text-transform: uppercase; letter-spacing: 0.05em; transition: transform 0.2s;
        }
        .btn-spotify:hover { transform: scale(1.05); background: #1ed760; }

        .hidden { display: none !important; }
        
        /* Heatmap */
        .heatmap-container { display: flex; justify-content: center; overflow-x: auto; padding: 20px 0; }
        .heatmap-grid { display: grid; grid-template-rows: repeat(7, 12px); grid-auto-flow: column; gap: 3px; }
        .heatmap-cell { width: 12px; height: 12px; border-radius: 2px; background-color: #222; }
        .level-1 { background: #0e4429; } .level-2 { background: #006d32; } .level-3 { background: #26a641; } .level-4 { background: #39d353; }

        /* Charts */
        .chart-wrapper { height: 350px; width: 100%; position: relative; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

        ol { padding-left: 20px; color: var(--text-secondary); }
        li { margin-bottom: 8px; }
        li strong { color: white; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-section" class="">
        <h1 style="font-size:3rem; margin-bottom:1rem;">Spotify Ultimate Stats</h1>
        <p style="color:#aaa; max-width:400px; margin-bottom:40px;">Connectez-vous pour acc√©der √† vos statistiques d√©taill√©es, votre historique complet et vos tops artistes.</p>
        <button id="login-btn" class="btn-spotify">Se connecter avec Spotify</button>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="container hidden">
        <h1>Bonjour <span id="user-display-name">...</span></h1>
        
        <!-- 3 Stats Cards -->
        <div class="stats-grid">
            <div class="card green">
                <div class="stat-label">√âcoutes Totales</div>
                <div class="big-stat" id="db-total-tracks">...</div>
            </div>
            <div class="card purple">
                <div class="stat-label">Titres Uniques</div>
                <div class="big-stat" id="db-unique-tracks">...</div>
            </div>
            <div class="card blue">
                <div class="stat-label">Temps d'√©coute</div>
                <div class="big-stat" id="db-total-time">...</div>
            </div>
        </div>

        <!-- Graphique Rythme -->
        <div class="card">
            <div class="chart-header">
                <h3>üìä Votre Rythme</h3>
                <div class="chart-toggles">
                    <button class="filter-btn active" id="btn-chart-daily" onclick="switchChartMode('daily')">Jours</button>
                    <button class="filter-btn" id="btn-chart-hourly" onclick="switchChartMode('hourly')">Heures</button>
                </div>
            </div>
            <div class="chart-wrapper">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- Classement BDD -->
        <h2 id="top-tracks-title">üèÜ Top 10 (Historique Complet)</h2>
        <div class="card">
            <table class="track-table">
                <thead><tr><th>#</th><th>Titre</th><th>Artiste</th><th>√âcoutes</th></tr></thead>
                <tbody id="db-top-tracks"></tbody>
            </table>
        </div>
        
        <!-- SECTION TIME TRAVEL -->
        <h2>‚è≥ Time Travel</h2>
        <div class="card">
            <div class="controls">
                <button class="filter-btn" onclick="timeTravel('month')">Il y a 1 Mois</button>
                <button class="filter-btn" onclick="timeTravel('six_months')">Il y a 6 Mois</button>
                <button class="filter-btn" onclick="timeTravel('year')">Il y a 1 An</button>
            </div>
            <div id="time-travel-result" style="text-align:center; min-height: 50px; color:#888;">
                Cliquez sur un bouton pour voir ce que vous √©coutiez...
            </div>
        </div>
        
        <!-- SECTION FID√âLIT√â -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:50px; margin-bottom:20px;">
            <h2 style="margin:0;">üíé Fid√©lit√© Artiste</h2>
            <a href="library.html" class="filter-btn" style="text-decoration:none; font-size:0.9rem;">üìö Voir toute la biblioth√®que</a>
        </div>

        <div class="card">
            <table class="track-table">
                <thead><tr><th>Artiste</th><th>Titres Uniques</th><th>Jauge de Fan</th></tr></thead>
                <tbody id="loyalty-table"></tbody>
            </table>
        </div>

        <!-- HEATMAP -->
        <div class="card" style="margin-top: 40px;">
            <div class="chart-header">
                <h3>üìÖ Calendrier d'√âcoute</h3>
                <select id="heatmap-year-select" class="filter-btn" style="padding:4px 12px;">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                </select>
            </div>
            <div class="heatmap-container">
                <div class="heatmap-grid" id="heatmap-grid"></div>
            </div>
        </div>

        <br><hr style="border-color:#333"><br>

        <!-- API DIRECT -->
        <h2>üî• Vos Tops Actuels (Spotify Live)</h2>
        <div class="controls">
            <button class="filter-btn active" onclick="changeRange('short_term', this)">4 Semaines</button>
            <button class="filter-btn" onclick="changeRange('medium_term', this)">6 Mois</button>
            <button class="filter-btn" onclick="changeRange('long_term', this)">Toujours</button>
        </div>
        <div class="stats-grid">
            <div class="card"><h3>Top Artistes</h3><ol id="api-artists"></ol></div>
            <div class="card"><h3>Top Titres</h3><ol id="api-tracks"></ol></div>
        </div>
    </div>

<script>
    // --- 1. CONFIGURATION R√âCUP√âR√âE ---
    const CLIENT_ID = '1f8e5a30d7d4470aa41dd7ba69e4a94f'; 
    // IMPORTANT : Si vous √™tes en local, commentez la ligne GitHub et d√©commentez celle du localhost !
    const REDIRECT_URI = 'https://gaetanlollieric.github.io/stats-spotify/index.html';
    // const REDIRECT_URI = 'http://127.0.0.1:5500/index.html'; 
    
    const SCOPES = "user-top-read user-read-recently-played user-read-private";
    
    // Supabase
    const SUPABASE_URL = 'https://kvrwymmsgwstvyqmscuy.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2cnd5bW1zZ3dzdHZ5cW1zY3V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NjAxODksImV4cCI6MjA3OTMzNjE4OX0.XNJOD5MzOaM8u_tRuvXZvx2Q_mHUTbk-mAbUFnoU3H4'; 
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    let spotifyToken = null;
    let chartInstance = null; 

    // --- 2. GESTION DE SESSION (FIX) ---
    function handleSession() {
        const hash = window.location.hash;
        let token = localStorage.getItem('spotify_token');
        let tokenTime = localStorage.getItem('spotify_token_time');
        const now = Date.now();

        // Cas 1 : Retour de connexion Spotify
        if (hash) {
            const params = new URLSearchParams(hash.substring(1));
            const newToken = params.get('access_token');
            if (newToken) {
                token = newToken;
                localStorage.setItem('spotify_token', token);
                localStorage.setItem('spotify_token_time', now);
                window.location.hash = ''; // Nettoyage URL
            }
        }

        // Cas 2 : V√©rification validit√© (1h)
        if (token && tokenTime && (now - tokenTime < 3600000)) {
            spotifyToken = token;
            showDashboard();
        } else {
            showLogin();
        }
    }

    function showLogin() {
        document.getElementById('login-section').classList.remove('hidden');
        document.getElementById('dashboard').classList.add('hidden');
    }

    function showDashboard() {
        document.getElementById('login-section').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        
        // Lancement des chargements
        fetchUserProfile();
        fetchSupabaseStats(); 
        fetchSpotifyTop('short_term'); 
        renderHeatmap(2025);
    }

    document.getElementById('login-btn').addEventListener('click', () => {
        const url = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}&show_dialog=false`;
        window.location.href = url;
    });


    // --- 3. LOGIQUE M√âTIER ---

    // A. Profil
    async function fetchUserProfile() {
        const res = await fetch('https://api.spotify.com/v1/me', { headers: { Authorization: `Bearer ${spotifyToken}` } });
        const data = await res.json();
        document.getElementById('user-display-name').innerText = data.display_name;
        localStorage.setItem('my_spotify_id', data.id);
    }

    // B. Tops API
    async function fetchSpotifyTop(range) {
        const headers = { Authorization: `Bearer ${spotifyToken}` };
        
        const resA = await fetch(`https://api.spotify.com/v1/me/top/artists?time_range=${range}&limit=5`, { headers });
        const dataA = await resA.json();
        const listA = document.getElementById('api-artists');
        listA.innerHTML = dataA.items ? dataA.items.map(a => `<li><strong>${a.name}</strong> <span style="font-size:0.8rem; color:#666">(${a.genres[0] || '...'})</span></li>`).join('') : '<li>Pas de donn√©es</li>';

        const resT = await fetch(`https://api.spotify.com/v1/me/top/tracks?time_range=${range}&limit=5`, { headers });
        const dataT = await resT.json();
        const listT = document.getElementById('api-tracks');
        listT.innerHTML = dataT.items ? dataT.items.map(t => `<li><strong>${t.name}</strong> - ${t.artists[0].name}</li>`).join('') : '<li>Pas de donn√©es</li>';
    }

    window.changeRange = (range, btn) => {
        document.querySelectorAll('.controls .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        fetchSpotifyTop(range);
    };

    // C. Stats Supabase
    async function fetchSupabaseStats() {
        const myId = localStorage.getItem('my_spotify_id');
        if(!myId) { setTimeout(fetchSupabaseStats, 500); return; } // Attendre si id pas encore charg√©

        const { count, error } = await sb.from('listening_history').select('*', { count: 'exact', head: true }).eq('user_id', myId);
        document.getElementById('db-total-tracks').innerText = count || 0;

        const { data: history } = await sb
            .from('listening_history')
            .select('played_at, tracks(name, duration_ms, artists(name))')
            .eq('user_id', myId)
            .limit(10000); 

        if(!history) return;

        let totalTimeMs = 0;
        const trackCounts = {};
        const artistCounts = {};
        const hours = new Array(24).fill(0);
        const days = new Array(7).fill(0);

        history.forEach(item => {
            if(!item.tracks) return;
            
            totalTimeMs += item.tracks.duration_ms || 0;
            const tName = item.tracks.name;
            const aName = item.tracks.artists?.name || 'Inconnu';
            
            trackCounts[tName] = (trackCounts[tName] || 0) + 1;
            
            if(!artistCounts[aName]) artistCounts[aName] = new Set();
            artistCounts[aName].add(tName);

            const date = new Date(item.played_at);
            hours[date.getHours()]++;
            days[date.getDay()]++;
        });

        const hoursTotal = Math.floor(totalTimeMs / (1000 * 60 * 60));
        document.getElementById('db-total-time').innerText = `${hoursTotal}h`;
        document.getElementById('db-unique-tracks').innerText = Object.keys(trackCounts).length;

        // Top 10 Table
        const sortedTracks = Object.entries(trackCounts).sort(([,a], [,b]) => b - a).slice(0, 10);
        const tbody = document.getElementById('db-top-tracks');
        tbody.innerHTML = sortedTracks.map(([name, count], i) => {
            const trackRef = history.find(h => h.tracks?.name === name);
            const artist = trackRef?.tracks?.artists?.name || '...';
            return `<tr><td>#${i+1}</td><td><strong style="color:white">${name}</strong></td><td>${artist}</td><td>${count}</td></tr>`;
        }).join('');

        // Fid√©lit√©
        const sortedLoyalty = Object.entries(artistCounts)
            .map(([name, set]) => ({ name, unique: set.size }))
            .sort((a,b) => b.unique - a.unique)
            .slice(0, 5);

        const loyaltyBody = document.getElementById('loyalty-table');
        loyaltyBody.innerHTML = sortedLoyalty.map(a => `
            <tr>
                <td><strong>${a.name}</strong></td>
                <td>${a.unique} titres</td>
                <td><div style="width:${Math.min(a.unique*2, 100)}px; height:6px; background:#1ED760; border-radius:3px;"></div></td>
            </tr>
        `).join('');

        // Graphique
        renderChart(days, hours);
    }

    // D. Graphique
    function renderChart(daysData, hoursData) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(30, 215, 96, 0.5)');
        gradient.addColorStop(1, 'rgba(30, 215, 96, 0)');

        window.chartData = { days: daysData, hours: hoursData };

        if(chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'],
                datasets: [{
                    label: '√âcoutes',
                    data: daysData, 
                    borderColor: '#1ED760',
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { grid: { color: '#333' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    window.switchChartMode = (mode) => {
        document.getElementById('btn-chart-daily').classList.toggle('active', mode === 'daily');
        document.getElementById('btn-chart-hourly').classList.toggle('active', mode === 'hourly');

        if(mode === 'daily') {
            chartInstance.data.labels = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            chartInstance.data.datasets[0].data = window.chartData.days;
        } else {
            chartInstance.data.labels = Array.from({length:24}, (_,i) => i+'h');
            chartInstance.data.datasets[0].data = window.chartData.hours;
        }
        chartInstance.update();
    };

    // E. Heatmap (Demo)
    function renderHeatmap(year) {
        const grid = document.getElementById('heatmap-grid');
        grid.innerHTML = '';
        for(let i=0; i<365; i++) {
            const div = document.createElement('div');
            div.className = 'heatmap-cell';
            const level = Math.random() > 0.7 ? Math.floor(Math.random() * 4) + 1 : 0;
            if(level > 0) div.classList.add(`level-${level}`);
            grid.appendChild(div);
        }
    }
    
    window.timeTravel = (period) => {
        const messages = {
            'month': "Le mois dernier, vous √©tiez √† fond sur <strong>PNL</strong>.",
            'six_months': "Il y a 6 mois, c'√©tait l'√©t√© : beaucoup de <strong>The Weeknd</strong>.",
            'year': "Il y a un an, vous d√©couvriez <strong>Orelsan</strong>."
        };
        document.getElementById('time-travel-result').innerHTML = `<p style="font-size:1.1rem; color:white;">${messages[period]}</p>`;
    };

    handleSession();

</script>
</body>
</html>
