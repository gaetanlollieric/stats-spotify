<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Discover - Recommandations</title>
    <style>
        :root {
            --green: #1DB954;
            --black: #121212;
            --gray: #181818;
            --light-gray: #282828;
            --text: #FFFFFF;
            --subtext: #B3B3B3;
        }

        body {
            font-family: 'Circular', sans-serif;
            background-color: var(--black);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 900px; margin: 0 auto; }

        /* HEADER & NAVIGATION */
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
        .back-btn { color: var(--subtext); text-decoration: none; font-weight: bold; }
        .back-btn:hover { color: var(--green); }

        /* TABS (ONGLETS) */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tab-btn {
            background: transparent; border: 2px solid var(--light-gray); color: var(--subtext);
            padding: 10px 25px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 1rem;
            transition: all 0.2s;
        }
        .tab-btn.active { border-color: var(--green); color: var(--text); background: rgba(29, 185, 84, 0.1); }
        .tab-btn:hover { border-color: var(--text); }

        /* SECTIONS DE RECHERCHE */
        .search-section {
            background: var(--gray); padding: 30px; border-radius: 10px; text-align: center;
            display: none; /* Cach√© par d√©faut */
        }
        .search-section.active { display: block; animation: fadeIn 0.3s; }

        input[type="text"], select {
            width: 100%; max-width: 400px; padding: 15px; border-radius: 30px; border: none;
            background: var(--light-gray); color: white; font-size: 1rem; outline: none; text-align: center;
        }
        input:focus { box-shadow: 0 0 0 2px var(--green); }

        /* RESULTATS DE RECHERCHE (DROPDOWN) */
        .results-dropdown {
            max-width: 400px; margin: 10px auto 0; background: #333; border-radius: 8px;
            max-height: 200px; overflow-y: auto; text-align: left; position: absolute;
            left: 0; right: 0; z-index: 10; display: none;
        }
        .dropdown-item {
            padding: 10px; border-bottom: 1px solid #444; cursor: pointer; display: flex; align-items: center;
        }
        .dropdown-item:hover { background: #444; }
        .dropdown-item img { width: 40px; height: 40px; border-radius: 4px; margin-right: 15px; object-fit: cover; }

        /* ELEMENT S√âLECTIONN√â */
        .selected-item {
            margin-top: 20px; padding: 15px; background: rgba(29, 185, 84, 0.2); border: 1px solid var(--green);
            border-radius: 8px; display: inline-flex; align-items: center; gap: 15px;
        }
        .selected-item button {
            background: transparent; border: none; color: white; font-size: 1.2rem; cursor: pointer;
        }

        /* BOUTON G√âN√âRER */
        .btn-generate {
            display: block; width: 100%; max-width: 300px; margin: 30px auto 0;
            padding: 15px; background: var(--green); color: white; border: none; border-radius: 50px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: transform 0.2s;
        }
        .btn-generate:hover { transform: scale(1.05); background: #1ed760; }
        .btn-generate:disabled { background: #555; cursor: not-allowed; transform: none; }

        /* OPTIONS AVANC√âES (ACCORD√âON) */
        .advanced-options { margin-top: 20px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; }
        details summary { color: var(--subtext); cursor: pointer; list-style: none; text-align: center; margin-bottom: 15px; }
        .slider-group { margin-bottom: 15px; }
        .slider-group label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--subtext); margin-bottom: 5px; }
        input[type=range] { width: 100%; accent-color: var(--green); }

        /* GRILLE DE RESULTATS */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 40px; }
        .card { background: var(--gray); padding: 15px; border-radius: 8px; transition: 0.3s; position: relative; }
        .card:hover { background: var(--light-gray); }
        .card img { width: 100%; aspect-ratio: 1; border-radius: 4px; margin-bottom: 10px; object-fit: cover; }
        .card h3 { margin: 0; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card p { margin: 5px 0 0; font-size: 0.85rem; color: var(--subtext); }
        .card-link { position: absolute; inset: 0; }

        /* MESSAGE D'ERREUR */
        .error-banner {
            background: #e91429; color: white; padding: 15px; border-radius: 8px;
            text-align: center; margin-bottom: 20px; display: none;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <a href="index.html" class="back-btn">‚Üê Retour</a>
            <h2 style="margin:0">D√©couvertes üîé</h2>
            <div style="width: 60px;"></div> <!-- Spacer -->
        </div>

        <div id="error-msg" class="error-banner"></div>

        <!-- ONGLETS -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('track')">üéµ Par Titre</button>
            <button class="tab-btn" onclick="switchTab('artist')">üë§ Par Artiste</button>
            <button class="tab-btn" onclick="switchTab('genre')">üéπ Par Genre</button>
        </div>

        <!-- 1. MODE TITRE -->
        <div id="section-track" class="search-section active">
            <h3>Trouver des musiques comme...</h3>
            <div style="position:relative">
                <input type="text" id="input-track" placeholder="Tapez le nom d'une musique..." autocomplete="off">
                <div id="results-track" class="results-dropdown"></div>
            </div>
            <!-- Selection display -->
            <div id="selection-track" class="selected-item" style="display:none;">
                <img id="img-track" src="" alt="" style="width:40px;height:40px;border-radius:4px;">
                <div>
                    <div id="txt-track-name" style="font-weight:bold"></div>
                    <div id="txt-track-artist" style="font-size:0.8rem;color:#ccc"></div>
                </div>
                <button onclick="clearSelection('track')">‚úï</button>
            </div>
            <input type="hidden" id="seed-track-id">
        </div>

        <!-- 2. MODE ARTISTE -->
        <div id="section-artist" class="search-section">
            <h3>Trouver des artistes comme...</h3>
            <div style="position:relative">
                <input type="text" id="input-artist" placeholder="Tapez le nom d'un artiste..." autocomplete="off">
                <div id="results-artist" class="results-dropdown"></div>
            </div>
            <!-- Selection display -->
            <div id="selection-artist" class="selected-item" style="display:none;">
                <img id="img-artist" src="" alt="" style="width:40px;height:40px;border-radius:50%;">
                <div id="txt-artist-name" style="font-weight:bold"></div>
                <button onclick="clearSelection('artist')">‚úï</button>
            </div>
            <input type="hidden" id="seed-artist-id">
        </div>

        <!-- 3. MODE GENRE -->
        <div id="section-genre" class="search-section">
            <h3>Explorer un style</h3>
            <select id="select-genre">
                <option value="">Chargement des genres...</option>
            </select>
        </div>

        <!-- OPTIONS AVANCEES (COMMUN) -->
        <div class="advanced-options">
            <details>
                <summary>Afficher les filtres avanc√©s (Humeur, √ânergie...)</summary>
                <div class="slider-group">
                    <label><span>Triste</span><span>Joyeux</span></label>
                    <input type="range" id="opt-valence" min="0" max="1" step="0.1" value="0.5">
                </div>
                <div class="slider-group">
                    <label><span>Calme</span><span>√ânergique</span></label>
                    <input type="range" id="opt-energy" min="0" max="1" step="0.1" value="0.5">
                </div>
                <div class="slider-group">
                    <label><span>Statique</span><span>Dansant</span></label>
                    <input type="range" id="opt-dance" min="0" max="1" step="0.1" value="0.5">
                </div>
            </details>
        </div>

        <button class="btn-generate" onclick="generate()">Lancer la recherche ‚ú®</button>

        <!-- GRID RESULTATS -->
        <div id="grid" class="grid"></div>
        <div id="loading" style="text-align:center; margin-top:40px; display:none; color:var(--subtext);">Recherche en cours...</div>

    </div>

        <script>
        // --- 1. RECUPERATION ET NETTOYAGE DU TOKEN (CRUCIAL) ---
        function getCleanToken() {
            let rawToken = localStorage.getItem('spotify_token');
            
            if (!rawToken) return null;

            // Enl√®ve les guillemets au d√©but et √† la fin si pr√©sents
            if (rawToken.startsWith('"') && rawToken.endsWith('"')) {
                rawToken = rawToken.slice(1, -1);
            }
            
            // V√©rifie si le token n'est pas litt√©ralement le mot "undefined" ou "null"
            if (rawToken === 'undefined' || rawToken === 'null') return null;
            
            return rawToken.trim(); // Enl√®ve les espaces vides
        }

        const token = getCleanToken();

        // --- 2. NAVIGATION ---
        let currentTab = 'track';

        function switchTab(tab) {
            currentTab = tab;
            // Mise √† jour visuelle des boutons
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            // Mise √† jour visuelle des sections
            document.querySelectorAll('.search-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`section-${tab}`).classList.add('active');
            
            // Nettoyage de la grille
            document.getElementById('grid').innerHTML = '';
        }

        // --- 3. INITIALISATION ---
        window.addEventListener('load', () => {
            console.log("Token utilis√© :", token); // Pour le debug (F12)

            if (!token) {
                displayError("Erreur d'authentification : Aucun token valide trouv√©. Veuillez retourner sur l'accueil pour vous reconnecter.");
            } else {
                setupAutocomplete('track');
                setupAutocomplete('artist');
                loadGenres(); // C'est souvent ici que √ßa bloquait
            }
        });

        // --- 4. CHARGEMENT DES GENRES ---
        async function loadGenres() {
            try {
                const res = await fetch('https://api.spotify.com/v1/recommendations/available-genre-seeds', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!res.ok) {
                    // Si erreur 401, c'est l'expiration
                    if (res.status === 401) {
                        displayError("Votre session a expir√©. Cliquez sur 'Se reconnecter'.");
                        return;
                    }
                    throw new Error(`Statut HTTP: ${res.status}`);
                }
                
                const data = await res.json();
                
                const select = document.getElementById('select-genre');
                // On garde l'option par d√©faut et on ajoute les autres
                select.innerHTML = '<option value="">-- Choisir un style --</option>';
                
                data.genres.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g;
                    // Premi√®re lettre en majuscule
                    opt.textContent = g.charAt(0).toUpperCase() + g.slice(1);
                    select.appendChild(opt);
                });

            } catch (e) {
                console.error("Erreur Genres:", e);
                // On n'affiche pas l'erreur √† l'utilisateur pour les genres, c'est pas bloquant pour les autres onglets
            }
        }

        // --- 5. RECHERCHE (AUTOCOMPLETE) ---
        function setupAutocomplete(type) {
            const input = document.getElementById(`input-${type}`);
            const results = document.getElementById(`results-${type}`);
            let timer;

            input.addEventListener('input', (e) => {
                clearTimeout(timer);
                const query = e.target.value;
                if(query.length < 2) { results.style.display = 'none'; return; }

                timer = setTimeout(() => { searchSpotify(query, type); }, 400);
            });

            // Fermer si clic dehors
            document.addEventListener('click', (e) => {
                if(!e.target.closest(`#section-${type}`)) results.style.display = 'none';
            });
        }

        async function searchSpotify(query, type) {
            try {
                const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=${type}&limit=5`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) return; // On ignore silencieusement les erreurs de frappe rapide

                const data = await res.json();
                const items = (type === 'track') ? data.tracks.items : data.artists.items;
                showDropdown(items, type);
            } catch (e) { console.error(e); }
        }

        function showDropdown(items, type) {
            const div = document.getElementById(`results-${type}`);
            div.innerHTML = '';
            div.style.display = 'block';

            if(items.length === 0) {
                div.style.display = 'none';
                return;
            }

            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'dropdown-item';
                
                let imgUrl = 'https://via.placeholder.com/45';
                if(item.images && item.images.length) imgUrl = item.images[item.images.length-1].url;
                else if(item.album && item.album.images.length) imgUrl = item.album.images[item.album.images.length-1].url;

                let subText = (type === 'track') ? item.artists[0].name : 'Artiste';

                row.innerHTML = `
                    <img src="${imgUrl}">
                    <div>
                        <div style="font-weight:bold; font-size:0.9rem">${item.name}</div>
                        <div style="font-size:0.8em; color:#bbb">${subText}</div>
                    </div>
                `;
                row.onclick = () => selectItem(item, type, imgUrl, subText);
                div.appendChild(row);
            });
        }

        function selectItem(item, type, imgUrl, subText) {
            document.getElementById(`seed-${type}-id`).value = item.id;
            
            // UI Switch
            document.getElementById(`results-${type}`).style.display = 'none';
            document.getElementById(`input-${type}`).style.display = 'none';
            
            const selDiv = document.getElementById(`selection-${type}`);
            selDiv.style.display = 'inline-flex';
            
            if(type === 'track') {
                document.getElementById('img-track').src = imgUrl;
                document.getElementById('txt-track-name').textContent = item.name;
                document.getElementById('txt-track-artist').textContent = subText;
            } else {
                document.getElementById('img-artist').src = imgUrl;
                document.getElementById('txt-artist-name').textContent = item.name;
            }
        }

        function clearSelection(type) {
            document.getElementById(`seed-${type}-id`).value = '';
            document.getElementById(`selection-${type}`).style.display = 'none';
            document.getElementById(`input-${type}`).style.display = 'inline-block';
            document.getElementById(`input-${type}`).value = '';
            document.getElementById(`input-${type}`).focus();
        }

        // --- 6. GENERATION FINALE ---
        async function generate() {
            const grid = document.getElementById('grid');
            const loader = document.getElementById('loading');
            const errorDiv = document.getElementById('error-msg');
            
            grid.innerHTML = '';
            errorDiv.style.display = 'none';
            
            // Validation
            let url = 'https://api.spotify.com/v1/recommendations?limit=24&market=FR';
            let hasSeed = false;

            if (currentTab === 'track') {
                const id = document.getElementById('seed-track-id').value;
                if(id) { url += `&seed_tracks=${id}`; hasSeed = true; }
            } else if (currentTab === 'artist') {
                const id = document.getElementById('seed-artist-id').value;
                if(id) { url += `&seed_artists=${id}`; hasSeed = true; }
            } else if (currentTab === 'genre') {
                const genre = document.getElementById('select-genre').value;
                if(genre) { url += `&seed_genres=${genre}`; hasSeed = true; }
            }

            if(!hasSeed) {
                alert("Attention : Vous devez s√©lectionner une musique, un artiste ou un genre pour lancer la recherche.");
                return;
            }

            // Ajout des Sliders
            url += `&target_valence=${document.getElementById('opt-valence').value}`;
            url += `&target_energy=${document.getElementById('opt-energy').value}`;
            url += `&target_danceability=${document.getElementById('opt-dance').value}`;

            loader.style.display = 'block';

            try {
                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.status === 401) {
                    displayError("Votre session a expir√©.");
                    return;
                }
                
                if (!res.ok) {
                    const errTxt = await res.text();
                    throw new Error("Erreur Spotify: " + errTxt);
                }
                
                const data = await res.json();
                
                // Si pas d'erreur mais tracks vide
                if (!data.tracks || data.tracks.length === 0) {
                     grid.innerHTML = '<p style="text-align:center; grid-column:1/-1">Aucun r√©sultat trouv√©. Essayez de changer de style ou de titre de r√©f√©rence.</p>';
                } else {
                    displayTracks(data.tracks);
                }

            } catch (e) {
                console.error(e);
                displayError("Erreur technique : " + e.message);
            } finally {
                loader.style.display = 'none';
            }
        }

        function displayTracks(tracks) {
            const grid = document.getElementById('grid');
            
            tracks.forEach(track => {
                const img = track.album.images[0] ? track.album.images[0].url : '';
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <a href="${track.uri}" class="card-link"></a>
                    <img src="${img}" loading="lazy">
                    <h3>${track.name}</h3>
                    <p>${track.artists.map(a=>a.name).join(', ')}</p>
                `;
                grid.appendChild(div);
            });
        }

        function displayError(msg) {
            const el = document.getElementById('error-msg');
            const txt = document.getElementById('error-text');
            if(txt) txt.textContent = msg;
            else el.textContent = msg;
            
            // Ajoute le bouton retour si pas pr√©sent
            if(!el.innerHTML.includes('btn-reconnect')) {
                 el.innerHTML += '<br><a href="index.html" class="btn-reconnect">Se reconnecter</a>';
            }
            
            el.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
    </script>

</body>
</html>
