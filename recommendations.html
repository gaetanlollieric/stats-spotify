<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Discover (via Last.fm)</title>
    <style>
        :root {
            --green: #1DB954;
            --lastfm-red: #ba0000;
            --black: #121212;
            --gray: #181818;
            --light-gray: #282828;
            --text: #FFFFFF;
            --subtext: #B3B3B3;
        }

        body {
            font-family: 'Circular', sans-serif;
            background-color: var(--black);
            color: var(--text);
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 900px; margin: 0 auto; }

        /* HEADER & NAVIGATION */
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px; }
        .back-btn { color: var(--subtext); text-decoration: none; font-weight: bold; font-size: 0.9rem;}
        .back-btn:hover { color: var(--green); }

        /* TABS (ONGLETS) */
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; justify-content: center; }
        .tab-btn {
            background: transparent; border: 2px solid var(--light-gray); color: var(--subtext);
            padding: 10px 25px; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 1rem;
            transition: all 0.2s;
        }
        .tab-btn.active { border-color: var(--green); color: var(--text); background: rgba(29, 185, 84, 0.1); }
        .tab-btn:hover { border-color: var(--text); }

        /* SECTIONS DE RECHERCHE */
        .search-section {
            background: var(--gray); padding: 30px; border-radius: 10px; text-align: center;
            display: none; min-height: 150px;
        }
        .search-section.active { display: block; animation: fadeIn 0.3s; }

        input[type="text"] {
            width: 100%; max-width: 400px; padding: 15px; border-radius: 30px; border: none;
            background: var(--light-gray); color: white; font-size: 1rem; outline: none; text-align: center;
        }
        input:focus { box-shadow: 0 0 0 2px var(--green); }

        /* RESULTATS DE RECHERCHE (DROPDOWN) */
        .results-dropdown {
            max-width: 400px; margin: 10px auto 0; background: #333; border-radius: 8px;
            max-height: 250px; overflow-y: auto; text-align: left; position: absolute;
            left: 0; right: 0; z-index: 10; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .dropdown-item {
            padding: 10px; border-bottom: 1px solid #444; cursor: pointer; display: flex; align-items: center;
        }
        .dropdown-item:hover { background: #444; }
        .dropdown-item img { width: 45px; height: 45px; border-radius: 4px; margin-right: 15px; object-fit: cover; }

        /* ELEMENT S√âLECTIONN√â */
        .selected-item {
            margin-top: 20px; padding: 15px; background: rgba(29, 185, 84, 0.2); border: 1px solid var(--green);
            border-radius: 8px; display: inline-flex; align-items: center; gap: 15px;
        }
        .selected-item button {
            background: transparent; border: none; color: white; font-size: 1.2rem; cursor: pointer; opacity: 0.7;
        }
        .selected-item button:hover { opacity: 1; }

        /* BOUTON G√âN√âRER */
        .btn-generate {
            display: block; width: 100%; max-width: 300px; margin: 30px auto 0;
            padding: 15px; background: var(--green); color: white; border: none; border-radius: 50px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: transform 0.2s;
        }
        .btn-generate:hover { transform: scale(1.05); background: #1ed760; }

        /* GRILLE DE RESULTATS */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 40px; }
        .card { background: var(--gray); padding: 15px; border-radius: 8px; transition: 0.3s; position: relative; }
        .card:hover { background: var(--light-gray); transform: translateY(-5px); }
        .card img { width: 100%; aspect-ratio: 1; border-radius: 4px; margin-bottom: 10px; object-fit: cover; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .card h3 { margin: 0; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card p { margin: 5px 0 0; font-size: 0.85rem; color: var(--subtext); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .card-link { position: absolute; inset: 0; }

        /* MESSAGE D'ERREUR */
        .error-banner {
            background: #e91429; color: white; padding: 20px; border-radius: 8px;
            text-align: center; margin-bottom: 20px; display: none;
        }
        .btn-reconnect {
            background: white; color: black; padding: 8px 16px; border-radius: 20px; 
            text-decoration: none; font-weight: bold; display: inline-block; margin-top: 10px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <a href="index.html" class="back-btn">‚Üê Retour</a>
            <h2 style="margin:0">D√©couvertes üîé</h2>
            <div style="width: 60px;"></div>
        </div>

        <div id="error-msg" class="error-banner">
            <div id="error-text"></div>
            <a href="index.html" class="btn-reconnect">Se reconnecter</a>
        </div>

        <!-- ONGLETS -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('track')">üéµ Par Titre</button>
            <button class="tab-btn" onclick="switchTab('artist')">üë§ Par Artiste</button>
        </div>

        <!-- 1. MODE TITRE -->
        <div id="section-track" class="search-section active">
            <h3 style="margin-top:0">Trouver des musiques comme...</h3>
            <p style="color:var(--subtext); font-size:0.9rem; margin-bottom:20px;">Entrez le nom d'un titre.</p>
            
            <div style="position:relative">
                <input type="text" id="input-track" placeholder="Ex: Blinding Lights..." autocomplete="off">
                <div id="results-track" class="results-dropdown"></div>
            </div>
            
            <!-- Selection display -->
            <div id="selection-track" class="selected-item" style="display:none;">
                <img id="img-track" src="" alt="">
                <div style="text-align:left">
                    <div id="txt-track-name" style="font-weight:bold"></div>
                    <div id="txt-track-artist" style="font-size:0.8rem;color:#ccc"></div>
                </div>
                <button onclick="clearSelection('track')">‚úï</button>
            </div>
            <!-- Champs cach√©s pour Last.fm -->
            <input type="hidden" id="seed-track-name">
            <input type="hidden" id="seed-track-artist">
        </div>

        <!-- 2. MODE ARTISTE -->
        <div id="section-artist" class="search-section">
            <h3 style="margin-top:0">Trouver des artistes comme...</h3>
            <p style="color:var(--subtext); font-size:0.9rem; margin-bottom:20px;">Entrez le nom d'un artiste.</p>
            
            <div style="position:relative">
                <input type="text" id="input-artist" placeholder="Ex: Daft Punk..." autocomplete="off">
                <div id="results-artist" class="results-dropdown"></div>
            </div>
            
            <div id="selection-artist" class="selected-item" style="display:none;">
                <img id="img-artist" src="" alt="">
                <div id="txt-artist-name" style="font-weight:bold"></div>
                <button onclick="clearSelection('artist')">‚úï</button>
            </div>
            <input type="hidden" id="seed-artist-name">
        </div>

        <button class="btn-generate" onclick="generateHybrid()">Lancer la recherche ‚ú®</button>

        <!-- GRID RESULTATS -->
        <div id="grid" class="grid"></div>
        <div id="loading" style="text-align:center; margin-top:40px; display:none; color:var(--subtext);">
            Intelligence via Last.fm... Images via Spotify... üéß
        </div>

    </div>

        <script>
        // CONFIG
        const LASTFM_KEY = 'ae5109579cce83beacc8cfa66e897433';
        
        // --- 1. TOKEN ---
        function getCleanToken() {
            let rawToken = localStorage.getItem('spotify_token');
            if (!rawToken) return null;
            if (rawToken.startsWith('"') && rawToken.endsWith('"')) rawToken = rawToken.slice(1, -1);
            if (rawToken === 'undefined' || rawToken === 'null') return null;
            return rawToken.trim();
        }
        const token = getCleanToken();

        // --- 2. NAVIGATION ---
        let currentTab = 'track';

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.querySelectorAll('.search-section').forEach(s => s.classList.remove('active'));
            document.getElementById(`section-${tab}`).classList.add('active');
            document.getElementById('grid').innerHTML = '';
        }

        // --- 3. INIT ---
        window.addEventListener('load', () => {
            if (!token) displayError("Connectez-vous √† l'accueil pour voir les images.");
            else { setupAutocomplete('track'); setupAutocomplete('artist'); }
        });

        // --- 4. RECHERCHE VISUELLE (AUTOCOMPLETE) ---
        function setupAutocomplete(type) {
            const input = document.getElementById(`input-${type}`);
            const results = document.getElementById(`results-${type}`);
            let timer;

            input.addEventListener('input', (e) => {
                clearTimeout(timer);
                if(e.target.value.length < 2) { results.style.display = 'none'; return; }
                timer = setTimeout(() => { searchSpotify(e.target.value, type); }, 400);
            });

            document.addEventListener('click', (e) => {
                if(!e.target.closest(`#section-${type}`)) results.style.display = 'none';
            });
        }

        async function searchSpotify(query, type) {
            try {
                const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=${type}&limit=5`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return; 
                const data = await res.json();
                const items = (type === 'track') ? data.tracks.items : data.artists.items;
                showDropdown(items, type);
            } catch (e) { console.error(e); }
        }

        function showDropdown(items, type) {
            const div = document.getElementById(`results-${type}`);
            div.innerHTML = '';
            div.style.display = 'block';
            if(items.length === 0) { div.style.display = 'none'; return; }

            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'dropdown-item';
                let imgUrl = item.album ? (item.album.images[2]?.url || '') : (item.images[2]?.url || '');
                let subText = (type === 'track') ? item.artists[0].name : 'Artiste';

                row.innerHTML = `<img src="${imgUrl}" style="background:#333"><div><div style="font-weight:bold; font-size:0.9rem">${item.name}</div><div style="font-size:0.8em; color:#bbb">${subText}</div></div>`;
                
                row.onclick = () => selectItem(item, type, imgUrl, subText);
                div.appendChild(row);
            });
        }

        function selectItem(item, type, imgUrl, subText) {
            if(type === 'track') {
                document.getElementById('seed-track-name').value = item.name;
                document.getElementById('seed-track-artist').value = item.artists[0].name;
            } else {
                document.getElementById('seed-artist-name').value = item.name;
            }
            
            document.getElementById(`results-${type}`).style.display = 'none';
            document.getElementById(`input-${type}`).style.display = 'none';
            
            const selDiv = document.getElementById(`selection-${type}`);
            selDiv.style.display = 'inline-flex';
            
            if(type === 'track') {
                document.getElementById('img-track').src = imgUrl;
                document.getElementById('txt-track-name').textContent = item.name;
                document.getElementById('txt-track-artist').textContent = subText;
            } else {
                document.getElementById('img-artist').src = imgUrl;
                document.getElementById('txt-artist-name').textContent = item.name;
            }
        }

        function clearSelection(type) {
            if(type === 'track') {
                document.getElementById('seed-track-name').value = '';
                document.getElementById('seed-track-artist').value = '';
            } else {
                document.getElementById('seed-artist-name').value = '';
            }
            document.getElementById(`selection-${type}`).style.display = 'none';
            document.getElementById(`input-${type}`).style.display = 'inline-block';
            document.getElementById(`input-${type}`).value = '';
            document.getElementById(`input-${type}`).focus();
        }

        // --- 5. ALGORITHME HYBRIDE (CORRIG√â) ---
        async function generateHybrid() {
            const grid = document.getElementById('grid');
            const loader = document.getElementById('loading');
            const errorDiv = document.getElementById('error-msg');
            
            grid.innerHTML = '';
            errorDiv.style.display = 'none';
            loader.style.display = 'block';

            try {
                let similarItems = [];

                // A. LAST.FM (Le Cerveau)
                if (currentTab === 'track') {
                    const trackName = document.getElementById('seed-track-name').value;
                    const artistName = document.getElementById('seed-track-artist').value;
                    
                    if(!trackName) throw new Error("S√©lectionnez un titre.");

                    // On demande des titres similaires
                    const res = await fetch(`https://ws.audioscrobbler.com/2.0/?method=track.getsimilar&artist=${encodeURIComponent(artistName)}&track=${encodeURIComponent(trackName)}&api_key=${LASTFM_KEY}&format=json&limit=12`);
                    const data = await res.json();
                    
                    if(data.error) throw new Error(data.message);
                    if(!data.similartracks || !data.similartracks.track.length) throw new Error("Pas de titres similaires trouv√©s.");
                    
                    // --- CORRECTION MAJEURE ICI ---
                    // On cr√©e une requ√™te "floue" : "Titre Artiste" sans sp√©cifier "track:" ou "artist:"
                    // Cela permet √† Spotify de trouver le morceau m√™me s'il y a une faute ou "Remastered"
                    similarItems = data.similartracks.track.map(t => ({
                        searchQuery: `${t.name} ${t.artist.name}`, 
                        title: t.name,
                        artist: t.artist.name
                    }));

                } else {
                    const artistName = document.getElementById('seed-artist-name').value;
                    if(!artistName) throw new Error("S√©lectionnez un artiste.");

                    const res = await fetch(`https://ws.audioscrobbler.com/2.0/?method=artist.getsimilar&artist=${encodeURIComponent(artistName)}&api_key=${LASTFM_KEY}&format=json&limit=12`);
                    const data = await res.json();

                    if(data.error) throw new Error(data.message);
                    if(!data.similarartists || !data.similarartists.artist.length) throw new Error("Pas d'artistes similaires trouv√©s.");

                    similarItems = data.similarartists.artist.map(a => ({
                        searchQuery: `artist:${a.name}`, // Pour les artistes, le filtre strict marche bien
                        name: a.name
                    }));
                }

                // B. SPOTIFY (L'Affichage)
                const spotifyPromises = similarItems.map(async (item) => {
                    try {
                        // On cherche le titre sur Spotify
                        const searchRes = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(item.searchQuery)}&type=${currentTab}&limit=1`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const searchData = await searchRes.json();
                        
                        if (currentTab === 'track') {
                            // On v√©rifie qu'on a bien un r√©sultat
                            return (searchData.tracks && searchData.tracks.items.length > 0) ? searchData.tracks.items[0] : null;
                        } else {
                            return (searchData.artists && searchData.artists.items.length > 0) ? searchData.artists.items[0] : null;
                        }
                    } catch(e) { return null; }
                });

                const results = await Promise.all(spotifyPromises);
                const finalResults = results.filter(i => i !== null); // On garde que ce qu'on a trouv√©
                
                displayResults(finalResults);

            } catch (e) {
                console.error(e);
                displayError("Oups : " + e.message);
            } finally {
                loader.style.display = 'none';
            }
        }

        function displayResults(items) {
            const grid = document.getElementById('grid');
            
            if(items.length === 0) {
                grid.innerHTML = '<p style="text-align:center; grid-column:1/-1">Last.fm a des id√©es, mais impossible de les trouver sur Spotify (noms trop diff√©rents).</p>';
                return;
            }

            items.forEach(item => {
                let imgUrl = 'https://via.placeholder.com/150';
                let title = item.name;
                let subtitle = '';

                if (currentTab === 'track') {
                    if(item.album.images.length) imgUrl = item.album.images[1]?.url || item.album.images[0].url;
                    subtitle = item.artists.map(a=>a.name).join(', ');
                } else {
                    if(item.images.length) imgUrl = item.images[1]?.url || item.images[0].url;
                    subtitle = 'Artiste similaire';
                }

                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <a href="${item.uri}" class="card-link"></a>
                    <img src="${imgUrl}" loading="lazy">
                    <h3>${title}</h3>
                    <p>${subtitle}</p>
                `;
                grid.appendChild(div);
            });
        }

        function displayError(msg) {
            const el = document.getElementById('error-msg');
            const txt = document.getElementById('error-text');
            if(txt) txt.textContent = msg; else el.textContent = msg;
            el.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
    </script>

</body>
</html>
