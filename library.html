<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Ma Biblioth√®que - Spotify Stats</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* --- DESIGN MODERNE √âPUR√â --- */
        :root {
            --primary: #1ED760;
            --bg-main: #0b0b0b;
            --bg-elevated: #181818; /* Fond des cartes */
            --bg-hover: #222222;
            --text-main: #FFFFFF;
            --text-secondary: #A7A7A7;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --radius-lg: 16px;
            --radius-full: 999px;
            --font-stack: 'Circular', -apple-system, sans-serif;
        }

        body {
            font-family: var(--font-stack); background-color: var(--bg-main);
            color: var(--text-main); margin: 0; padding: 30px;
        }
        
        .container { max-width: 1200px; margin: 0 auto; } /* Plus large pour les grosses cartes */

        /* Header Sticky effet "Verre" */
        .header-controls {
            position: sticky; top: 0; z-index: 100;
            background: rgba(11, 11, 11, 0.85); backdrop-filter: blur(12px);
            padding: 20px 0; border-bottom: 1px solid var(--border-subtle);
            margin: -30px -30px 30px -30px; padding-left: 30px; padding-right: 30px;
        }

        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: var(--text-secondary); font-weight: 600; font-size: 0.9rem; transition:0.2s; }
        .back-btn:hover { color: var(--primary); }
        h1 { margin: 0; color: var(--text-main); font-size: 1.8rem; font-weight: 700; }

        /* Input & Boutons */
        .search-bar {
            width: 100%; padding: 14px 24px; border-radius: var(--radius-full);
            border: 1px solid var(--border-subtle); background: var(--bg-elevated);
            color: white; font-size: 1rem; outline: none; margin-bottom: 20px; box-sizing: border-box;
            transition: all 0.2s;
        }
        .search-bar:focus { border-color: var(--primary); background: #202020; }

        .sort-buttons { display: flex; gap: 10px; }
        .sort-btn {
            background: var(--bg-elevated); border: 1px solid transparent; color: var(--text-main);
            padding: 8px 20px; border-radius: var(--radius-full); cursor: pointer; font-size: 0.9rem;
            font-weight: 600; transition: all 0.2s;
        }
        .sort-btn:hover { background: var(--bg-hover); transform: scale(1.02); }
        .sort-btn.active { background: var(--primary); color: black; }

        /* GRILLE DES ARTISTES (MODIFI√âE) */
        .artist-list {
            display: grid;
            /* Cartes plus larges : min 280px au lieu de 200px */
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .artist-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 20px; /* Plus d'espace interne */
            display: flex;
            align-items: center; /* Centr√© verticalement */
            gap: 20px; /* Espace entre photo et texte */
            cursor: pointer;
            transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
        }

        .artist-card:hover {
            transform: translateY(-4px);
            background: var(--bg-hover);
            border-color: rgba(255,255,255,0.15);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        
        /* Avatar Rond */
        .artist-avatar {
            width: 80px; height: 80px; /* Taille de l'image */
            border-radius: 50%;
            object-fit: cover;
            background-color: #333; /* Fallback si pas d'image */
            flex-shrink: 0; /* Emp√™che l'image de s'√©craser */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .artist-info { flex-grow: 1; overflow: hidden; }
        .artist-name { font-size: 1.1rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; margin-bottom: 4px; }
        .artist-count { font-size: 0.9rem; color: var(--text-secondary); }
        
        .rank-badge {
            background: rgba(30, 215, 96, 0.1); color: var(--primary);
            font-size: 0.85rem; padding: 4px 10px; border-radius: 6px;
            font-weight: 800; min-width: 30px; text-align: center;
        }

        .loader { text-align: center; color: var(--text-secondary); margin-top: 50px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-controls">
        <div class="top-nav">
            <a href="index.html" class="back-btn">‚Üê Retour au Dashboard</a>
            <h1>Ma Biblioth√®que</h1>
            <div id="total-count" style="color:#888; font-size:0.9rem;">...</div>
        </div>

        <input type="text" id="searchInput" class="search-bar" placeholder="üîç Rechercher un artiste...">
        
        <div class="sort-buttons">
            <button class="sort-btn active" onclick="setSort('count')">üî• Plus √©cout√©s</button>
            <button class="sort-btn" onclick="setSort('name')">üî§ Alphab√©tique</button>
        </div>
    </div>

    <div id="loader" class="loader">Chargement de la biblioth√®que...</div>
    <div id="artist-grid" class="artist-list"></div>
</div>

<script>
    // --- CONFIG ---
    const SUPABASE_URL = 'https://kvrwymmsgwstvyqmscuy.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2cnd5bW1zZ3dzdHZ5cW1zY3V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NjAxODksImV4cCI6MjA3OTMzNjE4OX0.XNJOD5MzOaM8u_tRuvXZvx2Q_mHUTbk-mAbUFnoU3H4'; 
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

    let allArtists = [];
    let currentSort = 'count';

    async function fetchAllArtists() {
        const myId = localStorage.getItem('my_spotify_id');
        if (!myId) {
            window.location.href = 'index.html';
            return;
        }
    
        // MODIFICATION ICI : On demande aussi 'image_url' (ou le nom de ta colonne image)
        const { data, error } = await sb
            .from('listening_history')
            .select(`
                tracks!inner (
                    artists!inner ( name, image_url ) 
                )
            `)
            .eq('user_id', myId)
            .limit(50000); 
    
        if (error) { 
            console.error(error); 
            document.getElementById('loader').innerText = "Erreur chargement.";
            return; 
        }
    
        // Aggr√©gation plus intelligente (on garde l'image)
        const artistsMap = {};
        
        data.forEach(row => {
            // S√©curit√© si donn√©es manquantes
            const artistData = row.tracks?.artists;
            if (!artistData) return;

            const name = artistData.name;
            const img = artistData.image_url; // R√©cup√©ration de l'image

            if (!artistsMap[name]) {
                artistsMap[name] = { 
                    name: name, 
                    count: 0, 
                    image: img // On stocke l'image trouv√©e
                };
            }
            artistsMap[name].count++;
        });

        // Transformation en tableau
        allArtists = Object.values(artistsMap);
        
        document.getElementById('total-count').innerText = `${allArtists.length} Artistes`;
        document.getElementById('loader').style.display = 'none';
        renderArtists();
    }

    function renderArtists() {
        const container = document.getElementById('artist-grid');
        const searchVal = document.getElementById('searchInput').value.toLowerCase();
        
        container.innerHTML = '';

        let filtered = allArtists.filter(a => a.name.toLowerCase().includes(searchVal));

        if (currentSort === 'count') {
            filtered.sort((a, b) => b.count - a.count);
        } else {
            filtered.sort((a, b) => a.name.localeCompare(b.name));
        }

        if (filtered.length === 0) {
            container.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#666;">Aucun artiste trouv√©.</p>';
            return;
        }

        const fragment = document.createDocumentFragment();
        
        // Image par d√©faut si l'URL est vide
        const defaultImg = "https://ui-avatars.com/api/?background=333&color=fff&name=";

        filtered.forEach((a, index) => {
            const card = document.createElement('div');
            card.className = 'artist-card';
            card.onclick = () => window.location.href = `artist.html?name=${encodeURIComponent(a.name)}`;

            const rankDisplay = currentSort === 'count' ? `<div class="rank-badge">#${index + 1}</div>` : '';
            
            // Gestion de l'image : si a.image existe on l'utilise, sinon on g√©n√®re un avatar avec les initiales
            const imageUrl = a.image ? a.image : (defaultImg + encodeURIComponent(a.name));

            card.innerHTML = `
                <img src="${imageUrl}" alt="${a.name}" class="artist-avatar" loading="lazy">
                
                <div class="artist-info">
                    <span class="artist-name">${a.name}</span>
                    <span class="artist-count">${a.count} √©coutes</span>
                </div>
                
                ${rankDisplay}
            `;
            fragment.appendChild(card);
        });

        container.appendChild(fragment);
    }

    window.setSort = (mode) => {
        currentSort = mode;
        document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        renderArtists();
    };

    document.getElementById('searchInput').addEventListener('input', renderArtists);
    fetchAllArtists();
</script>

</body>
</html>
