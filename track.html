<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>D√©tail du titre - Spotify Stats</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --spotify-green:#1ED760;
      --bg-main:#0b0b0b;
      --bg-elevated:#181818;
      --text-main:#FFFFFF;
      --text-secondary:#A7A7A7;
      --border-subtle:rgba(255,255,255,0.08);
      --radius-lg:16px;
      --radius-full:999px;
      --font-stack:'Circular',-apple-system,sans-serif;
    }
    body{
      font-family:var(--font-stack);
      background:var(--bg-main);
      color:var(--text-main);
      margin:0;
      padding:30px;
    }
    .container{max-width:900px;margin:0 auto;}
    a.back-btn{
      text-decoration:none;
      color:var(--text-secondary);
      font-size:0.9rem;
    }
    a.back-btn:hover{color:var(--spotify-green);}
    .track-header{
      display:flex;
      gap:24px;
      margin-top:20px;
      align-items:center;
    }
    .cover{
      width:160px;
      height:160px;
      border-radius:12px;
      object-fit:cover;
      background:#333;
      box-shadow:0 8px 24px rgba(0,0,0,0.5);
      flex-shrink:0;
    }
    .meta h1{
      margin:0 0 8px;
      font-size:1.8rem;
    }
    .meta .artist{
      color:var(--text-secondary);
      margin-bottom:6px;
    }
    .meta .album{
      color:var(--text-secondary);
      font-size:0.9rem;
    }
    .meta .info-line{
      color:var(--text-secondary);
      font-size:0.9rem;
      margin-top:4px;
    }
    .btn-spotify{
      margin-top:16px;
      background:var(--spotify-green);
      color:black;
      border:none;
      padding:10px 26px;
      border-radius:var(--radius-full);
      font-weight:700;
      cursor:pointer;
    }
    .btn-spotify:hover{filter:brightness(1.1);}
    .card{
      margin-top:30px;
      background:var(--bg-elevated);
      border-radius:var(--radius-lg);
      border:1px solid var(--border-subtle);
      padding:20px;
    }
    h2{margin-top:0;font-size:1.3rem;}
    .stat-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:8px;
      color:var(--text-secondary);
      font-size:0.95rem;
    }
    audio{width:100%;margin-top:10px;}

    /* Titres similaires */
    .similar-track {
      display:flex;
      align-items:center;
      gap:12px;
      padding:6px 0;
    }
    .similar-cover {
      width:46px;
      height:46px;
      border-radius:6px;
      object-fit:cover;
      background:#333;
      flex-shrink:0;
    }
    .similar-meta {
      flex:1;
      overflow:hidden;
    }
    .similar-title {
      font-size:0.9rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .similar-artist {
      font-size:0.8rem;
      color:var(--text-secondary);
    }
    .similar-btn {
      border:none;
      background:var(--spotify-green);
      color:black;
      border-radius:999px;
      padding:4px 10px;
      font-size:0.75rem;
      cursor:pointer;
      margin-left:4px;
    }
    .similar-btn:hover { filter:brightness(1.08); }
  </style>
</head>
<body>
<div class="container">
  <a href="index.html" class="back-btn">‚Üê Retour</a>

  <div id="track-main"></div>

  <div class="card" id="stats-card" style="display:none;">
    <h2>üìà Vos stats sur ce titre</h2>
    <div class="stat-row"><span>√âcoutes totales</span><span id="stat-count">0</span></div>
    <div class="stat-row"><span>Premi√®re √©coute</span><span id="stat-first">-</span></div>
    <div class="stat-row"><span>Derni√®re √©coute</span><span id="stat-last">-</span></div>
    <!-- la ligne du % sera ajout√©e en JS -->
  </div>

  <div class="card" id="similar-card" style="display:none; margin-top:20px;">
    <h2>üéß Titres similaires</h2>
    <div id="similar-list"></div>
  </div>
</div>

<script>
  // --- CONFIG SUPABASE (identique aux autres pages) ---
  const SUPABASE_URL = 'https://kvrwymmsgwstvyqmscuy.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2cnd5bW1zZ3dzdHZ5cW1zY3V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NjAxODksImV4cCI6MjA3OTMzNjE4OX0.XNJOD5MzOaM8u_tRuvXZvx2Q_mHUTbk-mAbUFnoU3H4';
  const { createClient } = supabase;
  const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

  const spotifyToken = localStorage.getItem('spotify_token');
  const mySpotifyId = localStorage.getItem('my_spotify_id');

  const params = new URLSearchParams(window.location.search);
  const trackId = params.get('track_id'); // ID Spotify du titre

  if (!spotifyToken || !mySpotifyId || !trackId) {
    document.getElementById('track-main').innerHTML =
      "<p>Impossible de charger ce titre. Retour au dashboard pour se reconnecter.</p>";
  } else {
    loadTrack();
    loadTrackStats();
    loadSimilarTracks();
  }

  async function spotifyFetch(url) {
    const res = await fetch(url, { headers: { Authorization: `Bearer ${spotifyToken}` } });
    if (!res.ok) {
      console.warn('Erreur Spotify', res.status, url);
      return null;
    }
    return res.json();
  }

  // --- Infos Spotify du titre ---
  async function loadTrack() {
    const t = await spotifyFetch(`https://api.spotify.com/v1/tracks/${encodeURIComponent(trackId)}`);
    if (!t) {
      document.getElementById('track-main').innerHTML = "<p>Titre introuvable sur Spotify.</p>";
      return;
    }

    const name = t.name;
    const artists = t.artists.map(a => a.name).join(', ');
    const album = t.album?.name || '';
    const cover = t.album?.images?.[0]?.url || '';
    const durationMs = t.duration_ms || 0;
    const preview = t.preview_url;
    const explicit = t.explicit;
    const popularity = t.popularity;
    const marketsCount = (t.available_markets || []).length;

    const mins = Math.floor(durationMs / 60000);
    const secs = Math.floor((durationMs % 60000) / 1000).toString().padStart(2,'0');

    const mainDiv = document.getElementById('track-main');
    mainDiv.innerHTML = `
      <div class="track-header">
        <img src="${cover}" alt="${name}" class="cover">
        <div class="meta">
          <h1>${name}</h1>
          <div class="artist">${artists}</div>
          <div class="album">Album : ${album}</div>
          <div class="info-line">Dur√©e : ${mins}:${secs}</div>
          <div class="info-line">Popularit√© : ${popularity}/100</div>
          <div class="info-line">March√©s disponibles : ${marketsCount}</div>
          <div class="info-line">Explicit : ${explicit ? 'Oui' : 'Non'}</div>
          <button class="btn-spotify" onclick="playTrack()">‚ñ∂ Lire sur Spotify</button>
          ${preview
            ? `<audio controls src="${preview}"></audio>`
            : '<div style="margin-top:10px;color:#888;font-size:0.85rem;">Pas de preview disponible</div>'}
        </div>
      </div>
    `;
  }

  // --- Stats perso + % d'√©coutes ---
  async function loadTrackStats() {
    // 1. Tous tes plays
    const { count: totalCount } = await sb
      .from('listening_history')
      .select('*', { count: 'exact', head: true })
      .eq('user_id', mySpotifyId);

    // 2. Plays pour ce titre
  const { data, count: trackCount, error } = await sb
    .from('listening_history')
    .select('played_at, tracks!inner(spotify_id)', { count: 'exact' })
    .eq('user_id', mySpotifyId)
    .eq('tracks.spotify_id', trackId)
    .order('played_at', { ascending: true });


    if (error || !data || !data.length) return;

    const first = new Date(data[0].played_at);
    const last = new Date(data[data.length - 1].played_at);
    const percent = totalCount ? ((trackCount / totalCount) * 100).toFixed(2) : 0;

    document.getElementById('stat-count').innerText = `${trackCount} √©coutes`;
    document.getElementById('stat-first').innerText = first.toLocaleString('fr-FR');
    document.getElementById('stat-last').innerText = last.toLocaleString('fr-FR');

    const statsCard = document.getElementById('stats-card');
    statsCard.style.display = 'block';

    const extra = document.createElement('div');
    extra.className = 'stat-row';
    extra.innerHTML = `<span>Part de tes √©coutes</span><span>${percent} %</span>`;
    statsCard.appendChild(extra);
  }

  // --- Lecture Spotify (ajout √† la file d'attente) ---
  async function playTrack() {
    if (!spotifyToken) return alert("Reconnecte-toi d'abord.");
  
    const res = await fetch(
      `https://api.spotify.com/v1/me/player/queue?uri=spotify:track:${encodeURIComponent(trackId)}`,
      { method:'POST', headers:{ Authorization:`Bearer ${spotifyToken}` } }
    );
  
    if (res.status === 204 || res.status === 200) {
      alert("Titre ajout√© √† la file d'attente de ton appareil Spotify actif.");
    } else if (res.status === 404) {
      alert("Aucun appareil actif d√©tect√©. Lance Spotify sur ton t√©l√©phone/PC.");
    } else if (res.status === 401) {
      alert("Session expir√©e, reconnecte-toi.");
    } else {
      alert("Impossible d'ajouter √† la file (code " + res.status + ").");
    }
  }


  // --- Titres similaires (API recommandations) ---
  async function loadSimilarTracks() {
    const res = await fetch(
      `https://api.spotify.com/v1/recommendations?seed_tracks=${encodeURIComponent(trackId)}&limit=10&market=FR`,
      { headers: { Authorization: `Bearer ${spotifyToken}` } }
    );
    if (!res.ok) {
      console.warn('Pas de recommandations pour ce titre', res.status);
      return;
    }
    const data = await res.json();
    const tracks = data.tracks || [];
    if (!tracks.length) return;

    const listDiv = document.getElementById('similar-list');
    listDiv.innerHTML = tracks.map(t => {
      const cover = t.album?.images?.[2]?.url || t.album?.images?.[0]?.url || '';
      const artists = t.artists.map(a => a.name).join(', ');
      return `
        <div class="similar-track">
          <img src="${cover}" class="similar-cover" alt="${t.name}">
          <div class="similar-meta">
            <div class="similar-title">${t.name}</div>
            <div class="similar-artist">${artists}</div>
          </div>
          <button class="similar-btn" onclick="openTrack('${t.id}')">D√©tail</button>
          <button class="similar-btn" onclick="queueTrack('${t.uri}')">+ File</button>
        </div>
      `;
    }).join('');

    document.getElementById('similar-card').style.display = 'block';
  }

  function openTrack(id) {
    window.location.href = `track.html?track_id=${encodeURIComponent(id)}`;
  }

  async function queueTrack(uri) {
    if (!spotifyToken) return alert("Session expir√©e, reconnecte-toi.");
    const res = await fetch(
      `https://api.spotify.com/v1/me/player/queue?uri=${encodeURIComponent(uri)}`,
      { method:'POST', headers:{ Authorization:`Bearer ${spotifyToken}` } }
    );
    if (res.status === 204) {
      alert("Ajout√© √† ta file d'attente Spotify.");
    } else if (res.status === 404) {
      alert("Aucun appareil actif d√©tect√©. Lance Spotify sur un appareil.");
    } else {
      alert("Impossible d'ajouter √† la file (code " + res.status + ").");
    }
  }
</script>
</body>
</html>
